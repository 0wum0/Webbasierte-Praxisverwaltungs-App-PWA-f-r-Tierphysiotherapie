# üß© Tierphysio Manager ‚Äì AutoFix Integration mit IntegrityCheck
# Erstellt f√ºr https://ew.makeit.uno von Florian Engelhardt ¬©2025

defaults:
  run_on_every_prompt: true

tasks:
  - name: "Tierphysio Auto-Integrity"
    trigger: ["beforePrompt", "beforeCommit"]
    action:
      run: |
        echo "üîç Pr√ºfe https://ew.makeit.uno/integrity.php ..."
        REPORT=$(curl -s https://ew.makeit.uno/integrity.php)

        echo "$REPORT" | grep "‚ö†Ô∏è" && echo "‚ö†Ô∏è Warnungen erkannt ‚Äì Starte Auto-Fix..." || echo "‚úÖ Keine Probleme erkannt."

        # --- 1. Fehlende base.twig Erweiterung hinzuf√ºgen ---
        echo "$REPORT" | grep "erweitert keine base.twig" | awk '{print $3}' | while read FILE; do
          if [ -f "$FILE" ]; then
            if ! grep -q "{% extends 'base.twig' %}" "$FILE"; then
              sed -i '1i {% extends "base.twig" %}' "$FILE"
              echo "üõ†Ô∏è base.twig-Erweiterung hinzugef√ºgt: $FILE"
            fi
          fi
        done

        # --- 2. Fehlende endblock am Ende erg√§nzen ---
        echo "$REPORT" | grep "kein endblock" | awk '{print $3}' | while read FILE; do
          if [ -f "$FILE" ]; then
            if ! grep -q "{% endblock %}" "$FILE"; then
              echo "{% endblock %}" >> "$FILE"
              echo "üõ†Ô∏è endblock erg√§nzt: $FILE"
            fi
          fi
        done

        # --- 3. Header Topbar pr√ºfen & ggf. erg√§nzen ---
        HEADER="includes/layout/header.php"
        if [ -f "$HEADER" ]; then
          if ! grep -q "topbar" "$HEADER"; then
            sed -i '2i <!-- AutoFix: Topbar erg√§nzt -->\n<div class="topbar"></div>' "$HEADER"
            echo "üõ†Ô∏è Topbar erg√§nzt in header.php"
          fi
        fi

        # --- 4. Modals mit fehlendem z-index reparieren ---
        echo "$REPORT" | grep "Modal ohne z-index" | awk '{print $2}' | while read PHPFILE; do
          if [ -f "$PHPFILE" ]; then
            sed -i 's/<div class="modal"/<div class="modal" style="z-index:1050"/g' "$PHPFILE"
            echo "üõ†Ô∏è Modal z-index korrigiert in: $PHPFILE"
          fi
        done

        # --- 5. Footer Fix: position fixed ‚Üí relative ---
        CSS="public/css/main.css"
        if [ -f "$CSS" ]; then
          if grep -q "position: fixed" "$CSS"; then
            sed -i 's/position: fixed/position: relative/g' "$CSS"
            echo "üõ†Ô∏è Footerposition korrigiert (relative)."
          fi
        fi

        echo "‚úÖ Auto-Fix abgeschlossen. Integrit√§tspr√ºfung kann erneut gestartet werden."            grep -q "topbar" includes/layout/header.php || \
              sed -i '2i <!-- üß© Auto-Fix: Topbar hinzugef√ºgt -->\n<div class="topbar"></div>' includes/layout/header.php
            echo "üõ†Ô∏è Header gepr√ºft und ggf. korrigiert."
          fi

          find . -type f -name "*.php" | while read php; do
            if grep -q "modal" "$php" && ! grep -q "z-index" "$php"; then
              sed -i 's/<div class="modal"/<div class="modal" style="z-index:1050"/g' "$php"
              echo "üõ†Ô∏è Modal z-index repariert: $php"
            fi
          done
          
          # 4Ô∏è‚É£ CSS Fix f√ºr Footer
          if grep -q "position: fixed" public/css/main.css; then
            sed -i 's/position: fixed/position: relative/g' public/css/main.css
            echo "üõ†Ô∏è Footer Fix: position nun relative."
          fi

          # 5Ô∏è‚É£ Abschlie√üende Kontrolle
          echo "‚úÖ Auto-Fix abgeschlossen. Bitte integrity.php neu laden und pr√ºfen!"
        else
          echo "‚úÖ Integrit√§tspr√ºfung bestanden ‚Äì keine Korrekturen n√∂tig."
        fi
