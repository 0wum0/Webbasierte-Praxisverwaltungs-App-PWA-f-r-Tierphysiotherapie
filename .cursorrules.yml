# üß† Tierphysio Manager ‚Äì Auto-Integrity + Auto-Fix System
# by Florian Engelhardt ¬© 2025

defaults:
  run_on_every_prompt: true   # üî• F√ºhrt Check + Fix bei jedem Cursor-Prompt automatisch aus

tasks:

  - name: "Integrity Auto-Check"
    trigger: ["beforeCommit", "beforePrompt"]
    action:
      run: |
        echo "üîç Starte automatische Integrit√§tspr√ºfung √ºber https://ew.makeit.uno/integrity.php ..."
        RESPONSE=$(curl -s https://ew.makeit.uno/integrity.php)

        if echo "$RESPONSE" | grep -E '‚ùå|‚ö†Ô∏è' >/dev/null; then
          echo "‚ö†Ô∏è Probleme erkannt ‚Äì Auto-Fix wird ausgef√ºhrt ..."
          
          # 1Ô∏è‚É£ Fehlende {% endblock %} in .twig-Dateien automatisch korrigieren
          find templates -type f -name "*.twig" | while read file; do
            if ! grep -q "{% endblock %}" "$file"; then
              echo "{% endblock %}" >> "$file"
              echo "üõ†Ô∏è endblock hinzugef√ºgt: $file"
            fi
          done
          
          # 2Ô∏è‚É£ base.twig-Erweiterung sicherstellen
          find templates -type f -name "*.twig" | while read file; do
            if ! grep -q "{% extends 'base.twig' %}" "$file" && [[ "$file" != *"base.twig"* ]]; then
              sed -i '1i {% extends "base.twig" %}' "$file"
              echo "üõ†Ô∏è base.twig-Erweiterung erg√§nzt: $file"
            fi
          done
          
          # 3Ô∏è‚É£ Header- und Modal-Fixes
          if [ -f includes/layout/header.php ]; then
            grep -q "topbar" includes/layout/header.php || \
              sed -i '2i <!-- üß© Auto-Fix: Topbar hinzugef√ºgt -->\n<div class="topbar"></div>' includes/layout/header.php
            echo "üõ†Ô∏è Header gepr√ºft und ggf. korrigiert."
          fi

          find . -type f -name "*.php" | while read php; do
            if grep -q "modal" "$php" && ! grep -q "z-index" "$php"; then
              sed -i 's/<div class="modal"/<div class="modal" style="z-index:1050"/g' "$php"
              echo "üõ†Ô∏è Modal z-index repariert: $php"
            fi
          done
          
          # 4Ô∏è‚É£ CSS Fix f√ºr Footer
          if grep -q "position: fixed" public/css/main.css; then
            sed -i 's/position: fixed/position: relative/g' public/css/main.css
            echo "üõ†Ô∏è Footer Fix: position nun relative."
          fi

          # 5Ô∏è‚É£ Abschlie√üende Kontrolle
          echo "‚úÖ Auto-Fix abgeschlossen. Bitte integrity.php neu laden und pr√ºfen!"
        else
          echo "‚úÖ Integrit√§tspr√ºfung bestanden ‚Äì keine Korrekturen n√∂tig."
        fi
