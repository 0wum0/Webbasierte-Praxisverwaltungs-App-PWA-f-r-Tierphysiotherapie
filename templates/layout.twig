<!doctype html>
<html lang="de" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark">
    <meta name="theme-color" content="#7C4DFF">
    
    <!-- Favicon -->
    <link rel="icon" href="assets/images/favicon-32x32.png" type="image/png" />
    
    <!-- Modern Font Stack -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Nunito+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Boxicons for additional icons -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    
    <!-- Main Theme CSS -->
    <link href="public/css/main.css" rel="stylesheet">
    
    <!-- Essential Plugins -->
    <link href="assets/plugins/simplebar/css/simplebar.css" rel="stylesheet" />
    <link href="assets/plugins/perfect-scrollbar/css/perfect-scrollbar.css" rel="stylesheet" />
    <link href="assets/plugins/metismenu/css/metisMenu.min.css" rel="stylesheet" />
    <link href="assets/plugins/datatable/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="assets/plugins/notifications/css/lobibox.min.css" />
    
    <!-- Loader -->
    <link href="assets/css/pace.min.css" rel="stylesheet" />
    <script src="assets/js/pace.min.js"></script>
    
    <!-- Apply theme immediately to prevent FOUC -->
    <script>
        (function() {
            const theme = localStorage.getItem('tierphysio-theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
    
    <!-- Theme Manager Scripts -->
    <script src="public/js/theme.js"></script>
    
    <title>{{ title|default("Tierphysio Manager üêæ") }}</title>
    
    <style>
        /* Global Violet Theme Overrides */
        :root {
            --primary-gradient: linear-gradient(135deg, #7C4DFF, #9C27B0);
            --primary-color: #7C4DFF;
            --primary-dark: #6B4BAE;
            --secondary-color: #9C27B0;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #f3f4f6;
            --text-primary: #2d3436;
            --text-secondary: #636e72;
            --text-muted: #b2bec3;
            --border-color: rgba(124, 77, 255, 0.1);
            --shadow-sm: 0 2px 4px rgba(124, 77, 255, 0.08);
            --shadow-md: 0 4px 12px rgba(124, 77, 255, 0.12);
            --shadow-lg: 0 8px 24px rgba(124, 77, 255, 0.15);
        }
        
        [data-theme="dark"] {
            --bg-primary: #1a1d23;
            --bg-secondary: #24272d;
            --bg-tertiary: #2e3137;
            --text-primary: #e4e6eb;
            --text-secondary: #b0b3b8;
            --text-muted: #8a8d91;
            --border-color: rgba(156, 39, 176, 0.2);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
        }
        
        /* Body styling */
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Poppins', 'Nunito Sans', sans-serif;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        /* Wrapper structure */
        .wrapper {
            display: flex;
            min-height: 100vh;
        }
        
        /* Page wrapper for content */
        .page-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-left: 260px;
            padding-top: 70px;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }
        
        .wrapper.toggled .page-wrapper {
            margin-left: 0;
        }
        
        @media (max-width: 991px) {
            .page-wrapper {
                margin-left: 0;
            }
        }
        
        .page-content {
            flex: 1;
            padding: 2rem;
            padding-bottom: 4rem; /* Space for scrollable footer */
        }
        
        /* Card styling */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        /* Button styling */
        .btn-primary {
            background: var(--primary-gradient);
            border: none;
            border-radius: 8px;
            padding: 0.5rem 1.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #6B4BAE, #8B1FA2);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        /* DataTables styling */
        .dataTables_wrapper {
            padding: 1rem 0;
        }
        
        table.dataTable {
            border: 1px solid var(--border-color) !important;
        }
        
        table.dataTable thead {
            background: var(--primary-gradient);
            color: white;
        }
        
        table.dataTable tbody tr:hover {
            background: rgba(124, 77, 255, 0.05);
        }
        
        /* Form controls */
        .form-control, .form-select {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(124, 77, 255, 0.1);
        }
        
        /* Modal styling */
        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }
        
        .modal-header {
            background: var(--primary-gradient);
            color: white;
            border-bottom: none;
        }
        
        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }
        
        /* Alert styling */
        .alert-success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(52, 211, 153, 0.1));
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #047857;
        }
        
        .alert-danger {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(248, 113, 113, 0.1));
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #991b1b;
        }
        
        .alert-warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(251, 191, 36, 0.1));
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #92400e;
        }
        
        .alert-info {
            background: linear-gradient(135deg, rgba(124, 77, 255, 0.1), rgba(156, 39, 176, 0.1));
            border: 1px solid rgba(124, 77, 255, 0.3);
            color: var(--primary-color);
        }
        
        /* Badge styling */
        .badge {
            padding: 0.35rem 0.65rem;
            border-radius: 6px;
            font-weight: 500;
        }
        
        .bg-primary {
            background: var(--primary-gradient) !important;
        }
    </style>
</head>

<body>
    <!-- Wrapper -->
    <div class="wrapper">
        
        <!-- Include Navigation Sidebar -->
        {% include '../includes/layout/nav.php' %}
        
        <!-- Include Header -->
        {% include '../includes/layout/header.php' %}
        
        <!-- Page Wrapper -->
        <div class="page-wrapper">
            <!-- Page Content -->
            <div class="page-content">
                {% block content %}{% endblock %}
            </div>
            <!-- End Page Content -->
        </div>
        <!-- End Page Wrapper -->
        
    </div>
    <!-- End Wrapper -->
    
    <!-- Footer (Scrollable) -->
    {% include '../includes/layout/footer.php' %}
    
    <!-- Back to top button is included in footer.php -->
    
    <!-- Core JavaScript -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    
    <!-- Plugins -->
    <script src="assets/plugins/simplebar/js/simplebar.min.js"></script>
    <script src="assets/plugins/metismenu/js/metisMenu.min.js"></script>
    <script src="assets/plugins/perfect-scrollbar/js/perfect-scrollbar.js"></script>
    <script src="assets/plugins/datatable/js/jquery.dataTables.min.js"></script>
    <script src="assets/plugins/datatable/js/dataTables.bootstrap5.min.js"></script>
    <script src="assets/plugins/notifications/js/lobibox.min.js"></script>
    <script src="assets/plugins/notifications/js/notifications.min.js"></script>
    
    <!-- App JS -->
    <script src="public/js/app.js"></script>
    
    <script>
        // Initialize DataTables with violet theme
        $(document).ready(function() {
            $('.datatable').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.13.7/i18n/de-DE.json"
                },
                "pageLength": 25,
                "responsive": true,
                "order": [[0, "desc"]]
            });
        });
        
        // Active navigation highlighting
        document.addEventListener("DOMContentLoaded", function() {
            const currentPath = window.location.pathname.split('/').pop();
            const navMap = {
                'dashboard.php': 'nav-dashboard',
                'patients.php': 'nav-patients',
                'appointments.php': 'nav-appointments',
                'notes.php': 'nav-notes',
                'invoices.php': 'nav-invoices',
                'owners.php': 'nav-owners',
                'owner_patient.php': 'nav-owner-patient',
                'bookkeeping.php': 'nav-bookkeeping',
                'settings.php': 'nav-settings'
            };
            
            const activeNavId = navMap[currentPath];
            if (activeNavId) {
                const navItem = document.getElementById(activeNavId);
                if (navItem) {
                    navItem.classList.add('active');
                    const link = navItem.querySelector('a');
                    if (link) {
                        link.classList.add('active');
                    }
                }
            }
        });
        
        // Global search functionality
        const searchInput = document.getElementById('globalSearch');
        const searchResults = document.getElementById('searchResults');
        
        if (searchInput && searchResults) {
            let searchTimeout;
            
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();
                
                if (query.length < 2) {
                    searchResults.style.display = 'none';
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    fetch(`api/search.php?q=${encodeURIComponent(query)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data && data.length > 0) {
                                let html = '';
                                data.forEach(item => {
                                    const badge = item.type === 'patient' ? 
                                        '<span class="badge bg-primary">Patient</span>' : 
                                        '<span class="badge bg-success">Besitzer</span>';
                                    html += `
                                        <div class="result-item" data-type="${item.type}" data-id="${item.id}">
                                            ${badge}
                                            <span>${item.label}</span>
                                        </div>
                                    `;
                                });
                                searchResults.innerHTML = html;
                                searchResults.style.display = 'block';
                                
                                // Add click handlers
                                searchResults.querySelectorAll('.result-item').forEach(item => {
                                    item.addEventListener('click', function() {
                                        const type = this.dataset.type;
                                        const id = this.dataset.id;
                                        if (type === 'patient') {
                                            window.location.href = `patient.php?id=${id}`;
                                        } else {
                                            window.location.href = `owner.php?id=${id}`;
                                        }
                                    });
                                });
                            } else {
                                searchResults.innerHTML = '<div class="no-results">Keine Ergebnisse gefunden</div>';
                                searchResults.style.display = 'block';
                            }
                        })
                        .catch(error => {
                            console.error('Search error:', error);
                        });
                }, 300);
            });
            
            // Hide results when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.style.display = 'none';
                }
            });
        }
    </script>
    
    <!-- Notifications -->
    {% if notifications %}
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            {% for n in notifications %}
            Lobibox.notify("{{ n.type }}", {
                pauseDelayOnHover: true,
                rounded: true,
                delay: 4000,
                size: 'mini',
                position: "top right",
                icon: '{{ n.icon|default("bx bx-info-circle") }}',
                msg: "{{ n.msg|e('js') }}"
            });
            {% endfor %}
        });
    </script>
    {% endif %}
    
    {% block scripts %}{% endblock %}
</body>
</html>