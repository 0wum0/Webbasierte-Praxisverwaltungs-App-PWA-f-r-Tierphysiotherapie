<!doctype html>
<html lang="de">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="color-scheme" content="light dark">
	<meta name="theme-color" content="#ffffff">
	<!--favicon-->
	<link rel="icon" href="assets/images/favicon-32x32.png" type="image/png" />

	<!-- Modern Font Stack -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Nunito+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">

	<!-- Main Theme CSS (New Design System) -->
	<link href="assets/css/main.css" rel="stylesheet">
	
	<!--plugins (keeping essential ones)-->
	<link href="assets/plugins/simplebar/css/simplebar.css" rel="stylesheet" />
	<link href="assets/plugins/perfect-scrollbar/css/perfect-scrollbar.css" rel="stylesheet" />
	<link href="assets/plugins/metismenu/css/metisMenu.min.css" rel="stylesheet" />
	<link href="assets/plugins/datatable/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
	<link rel="stylesheet" href="assets/plugins/notifications/css/lobibox.min.css" />

	<!-- loader-->
	<link href="assets/css/pace.min.css" rel="stylesheet" />
	<script src="assets/js/pace.min.js"></script>

	<!-- Bootstrap CSS (for compatibility) -->
	<link href="assets/css/bootstrap.min.css" rel="stylesheet">
	<link href="assets/css/bootstrap-extended.css" rel="stylesheet">

	<!-- Legacy Theme CSS (will be phased out) -->
	<link href="assets/css/app.css" rel="stylesheet">
	<link href="assets/css/icons.css" rel="stylesheet">
	
	<!-- Theme Manager Script (Load Early) -->
	<script src="assets/js/theme.js"></script>

	<title>{{ title|default("Tierphysio Manager üêæ") }}</title>

	<style>
		/* Modern Tierphysio Manager Design Overrides */
		:root {
			--primary-gradient: linear-gradient(135deg, #7B5BBE, #B9A9D0);
		}
		
		/* Flex Struktur */
		body, html {
			height: 100%;
			margin: 0;
			display: flex;
			flex-direction: column;
		}
		.wrapper {
			flex: 1;
			display: flex;
			flex-direction: column;
		}
		.page-wrapper {
			flex: 1;
			transition: margin-left 0.3s ease;
			padding-top: 70px; /* Platz f√ºr Header */
			min-height: calc(100vh - 55px); /* Platz f√ºr Footer ber√ºcksichtigen */
		}
		.page-content {
			padding-bottom: 55px; /* verhindert, dass Inhalt unter Footer l√§uft */
		}

		/* Modern Header with Theme Support */
		header {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			height: 70px;
			background: var(--color-bg);
			backdrop-filter: blur(12px);
			-webkit-backdrop-filter: blur(12px);
			z-index: 1030;
			border-bottom: 1px solid var(--color-border);
			box-shadow: 0 2px 8px var(--color-shadow);
			transition: var(--transition-base);
		}

		/* Modern Footer with Lilac Accent */
		.page-footer {
			position: fixed;
			bottom: 0;
			left: 0;
			width: 100%;
			height: 55px;
			background: var(--color-bg-secondary);
			backdrop-filter: blur(12px);
			-webkit-backdrop-filter: blur(12px);
			text-align: center;
			padding: 12px 0;
			box-shadow: 0 -2px 12px var(--color-shadow);
			border-top: 1px solid var(--color-border);
			z-index: 1000;
			font-weight: 500;
			overflow: hidden;
			transition: var(--transition-base);
		}
		.page-footer::after {
			content: "";
			position: absolute;
			top: 0;
			left: -40%;
			width: 40%;
			height: 100%;
			background: linear-gradient(120deg, transparent, rgba(255,255,255,.15), transparent);
			transform: skewX(-20deg);
			animation: footerShine 6s infinite;
			pointer-events: none;
		}
		@keyframes footerShine {
			0%   { left: -40%; }
			60%  { left: 120%; }
			100% { left: 120%; }
		}
		.page-footer p {
			margin: 0;
			letter-spacing: 0.5px;
			color: var(--color-text-muted);
		}
		.page-footer p:first-child {
			color: var(--color-text);
			margin-bottom: 4px;
		}
		.page-footer p:last-child {
			color: var(--color-text-muted);
			font-size: 0.8rem;
			margin: 0;
			opacity: 0;
			border-top: 1px solid var(--color-border);
			padding-top: 4px;
			animation: fadeInFooter 2s ease-in forwards;
		}
		.page-footer p:last-child:hover {
			color: var(--color-primary);
			text-shadow: 0 0 6px var(--color-shadow-hover);
			cursor: default;
		}
		@keyframes fadeInFooter {
			from { opacity: 0; transform: translateY(5px); }
			to   { opacity: 0.85; transform: translateY(0); }
		}
		
		/* Theme Toggle Button Styles */
		.theme-toggle-btn {
			background: var(--color-bg);
			border: 2px solid var(--color-primary);
			border-radius: 50%;
			width: 40px;
			height: 40px;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: all 0.3s ease;
			font-size: 18px;
			padding: 0;
		}
		
		.theme-toggle-btn:hover {
			background: var(--color-primary);
			transform: scale(1.1);
			box-shadow: 0 0 15px var(--color-shadow-hover);
		}
		
		/* Sidebar Menu Styling */
		.sidebar-nav .metismenu li a {
			color: var(--color-text);
			padding: 12px 20px;
			border-radius: 12px;
			transition: all 0.3s ease;
			display: flex;
			align-items: center;
			gap: 12px;
			text-decoration: none;
		}
		
		.sidebar-nav .metismenu li a:hover {
			background: var(--color-primary-lighter);
			color: var(--color-primary);
			transform: translateX(4px);
		}
		
		.sidebar-nav .metismenu li a.active,
		.sidebar-nav .metismenu li.active > a {
			background: var(--primary-gradient);
			color: white;
		}
		
		.sidebar-nav .metismenu .parent-icon {
			font-size: 20px;
			width: 24px;
			display: inline-flex;
			align-items: center;
			justify-content: center;
		}
		
		.menu-glow {
			position: relative;
		}
		
		.menu-glow::after {
			content: '';
			position: absolute;
			top: -2px;
			left: -2px;
			right: -2px;
			bottom: -2px;
			background: var(--primary-gradient);
			border-radius: 12px;
			opacity: 0;
			z-index: -1;
			transition: opacity 0.3s ease;
		}
		
		.menu-glow:hover::after {
			opacity: 0.3;
			animation: pulse 2s infinite;
		}
		
		@keyframes pulse {
			0%, 100% { transform: scale(1); }
			50% { transform: scale(1.05); }
		}

		/* Modern Sidebar with Lilac Accents */
		.sidebar-wrapper {
			width: 260px;
			background: var(--color-bg-secondary);
			backdrop-filter: blur(14px);
			-webkit-backdrop-filter: blur(14px);
			height: 100%;
			position: fixed;
			top: 0;
			left: -260px;
			transition: all 0.3s ease;
			z-index: 1045;
			display: flex;
			flex-direction: column;
			border-right: 1px solid var(--color-border);
		}
		.sidebar-wrapper.active { left: 0; }

		/* Logo/Header der Sidebar */
		.sidebar-header {
			padding: 16px;
			border-bottom: 1px solid rgba(255,255,255,0.1);
			flex-shrink: 0;
		}

		/* Men√ºbereich */
		.sidebar-nav {
			flex: 1;
			overflow-y: auto;
			padding-top: 65px; /* Abstand unter Logo */
		}
		.sidebar-nav .metismenu {
			padding-top: 10px;
		}

		.sidebar-overlay {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0,0,0,0.6);
			z-index: 1044;
		}
		.sidebar-overlay.active { display: block; }

		/* Desktop Sidebar sichtbar */
		@media (min-width: 992px) {
			.sidebar-wrapper { left: 0; }
			header { left: 260px; width: calc(100% - 260px); }
			.page-wrapper { margin-left: 260px; }
			.sidebar-overlay { display: none !important; }
			.wrapper.toggled .sidebar-wrapper { left: -260px; }
			.wrapper.toggled header { left: 0; width: 100%; }
			.wrapper.toggled .page-wrapper { margin-left: 0; }
		}

		/* ---- Globale Suchergebnisse (Dropdown) ---- */
		.search-bar { position: relative; }
		#searchResults {
			position: absolute;
			top: 100%;
			left: 0;
			right: 0;
			background: rgba(20,20,20,0.98);
			border: 1px solid rgba(0,229,255,0.25);
			box-shadow: 0 12px 24px rgba(0,0,0,0.45), 0 0 12px rgba(0,229,255,0.15) inset;
			border-radius: 10px;
			z-index: 2001;
			margin-top: 6px;
			display: none;
			overflow: hidden;
		}
		#searchResults .result-item {
			padding: 10px 14px;
			cursor: pointer;
			display: flex;
			align-items: center;
			gap: 10px;
			color: #eaeaea;
			border-bottom: 1px solid rgba(255,255,255,0.06);
		}
		#searchResults .result-item:last-child { border-bottom: 0; }
		#searchResults .result-item .badge {
			background: #00e5ff;
			color: #000;
			font-weight: 700;
			border-radius: 6px;
			min-width: 72px;
			text-align: center;
		}
		#searchResults .result-item.active,
		#searchResults .result-item:hover {
			background: rgba(0,229,255,0.12);
			color: #fff;
		}
		#searchResults .no-results {
			padding: 10px 14px;
			color: #aaa;
		}
	</style>
</head>

<body>
	<!--wrapper-->
	<div class="wrapper">

		<!--sidebar wrapper-->
		<div class="sidebar-wrapper" data-simplebar="true">
			<div class="sidebar-header">
				<div class="sidebar-logo">
					<span style="font-size: 24px;">üêæ</span>
					<span>Tierphysio Manager</span>
				</div>
				<div class="toggle-icon ms-auto"><i class='bx bx-arrow-back'></i></div>
			</div>

			<div class="sidebar-nav">
				<ul class="metismenu" id="menu">
					<li><a href="dashboard.php"><div class="parent-icon"><i class='bx bx-home-alt'></i></div><div class="menu-title">Dashboard</div></a></li>
					<li><a href="patients.php"><div class="parent-icon"><i class='bx bx-group'></i></div><div class="menu-title">Patienten</div></a></li>
					<li><a href="owners.php"><div class="parent-icon"><i class='bx bx-user'></i></div><div class="menu-title">Besitzer</div></a></li>
					<li>
						<a href="javascript:void(0);" data-bs-toggle="modal" data-bs-target="#newOwnerPatientModal">
							<div class="parent-icon menu-glow"><i class='bx bx-user-plus'></i></div>
							<div class="menu-title">Besitzer & Patient</div>
						</a>
					</li>
					<li><a href="appointments.php"><div class="parent-icon"><i class='bx bx-calendar'></i></div><div class="menu-title">Termine</div></a></li>
					<li><a href="invoices.php"><div class="parent-icon"><i class='bx bx-printer'></i></div><div class="menu-title">Rechnungen</div></a></li>
					<li><a href="notes.php"><div class="parent-icon"><i class='bx bx-note'></i></div><div class="menu-title">Notizen</div></a></li>
					<li><a href="settings.php"><div class="parent-icon"><i class='bx bx-cog'></i></div><div class="menu-title">Einstellungen</div></a></li>
				</ul>
			</div>
		</div>
		<div class="sidebar-overlay"></div>
		<!--end sidebar wrapper-->

		<!--start header -->
		<header>
			<div class="topbar d-flex align-items-center">
				<nav class="navbar navbar-expand gap-3">
					<div class="mobile-toggle-menu"><i class='bx bx-menu'></i></div>

					<div class="search-bar flex-grow-1">
						<div class="position-relative search-bar-box">
							<input type="text" id="globalSearch" class="form-control search-control" placeholder="Suche Patient/Besitzer...">
							<span class="position-absolute top-50 search-show translate-middle-y"><i class='bx bx-search'></i></span>
							<span class="position-absolute top-50 search-close translate-middle-y"><i class='bx bx-x'></i></span>
						</div>
						<!-- Dropdown mit Treffern -->
						<div id="searchResults"></div>
					</div>

					<div class="top-menu ms-auto">
						<ul class="navbar-nav align-items-center gap-1">
							<li class="nav-item">
								<button id="theme-toggle" class="theme-toggle-btn" data-theme-toggle aria-label="Toggle theme" title="Design wechseln">
									üåô
								</button>
							</li>
							<li class="nav-item mobile-search-icon d-flex d-lg-none" data-bs-toggle="modal" data-bs-target="#SearchModal">
								<a class="nav-link" href="javascript:;"><i class='bx bx-search'></i></a>
							</li>
						</ul>
					</div>
					<div class="user-box dropdown px-3">
						<a class="d-flex align-items-center nav-link dropdown-toggle gap-3" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
							<img src="assets/images/avatars/avatar-2.png" class="user-img" alt="user avatar">
							<div class="user-info">
								<p class="user-name mb-0">{{ user.name|default("Admin") }}</p>
								<p class="designattion mb-0">{{ user.role|default("Administrator") }}</p>
							</div>
						</a>
						<ul class="dropdown-menu dropdown-menu-end">
							<li><a class="dropdown-item" href="settings.php">‚öôÔ∏è Einstellungen</a></li>
							<li><a class="dropdown-item" href="logout.php">üö™ Abmelden</a></li>
						</ul>
					</div>
				</nav>
			</div>
		</header>
		<!--end header -->

		<!--start page wrapper -->
		<div class="page-wrapper flex-grow-1">
			<div class="page-content">
				{% block content %}{% endblock %}
			</div>
		</div>
		<!--end page wrapper -->

	</div>
	<!--end wrapper-->

	<!-- Footer -->
	<footer class="page-footer">
		<p>¬© {{ "now"|date("Y") }} Tierphysio Eileen Wenzel ‚Äì Alle Rechte vorbehalten.</p>
		<p>ERP-System f√ºr Tierphysiotherapeuten ‚Äì Coding & Design ¬© {{ "now"|date("Y") }} by Florian Engelhardt</p>
	</footer>

	<a href="javaScript:;" class="back-to-top"><i class='bx bxs-up-arrow-alt'></i></a>

	<!-- Modal f√ºr Suchdetails -->
	<div class="modal fade" id="searchDetailModal" tabindex="-1" aria-hidden="true">
	  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
	    <div class="modal-content bg-dark text-light">
	      <div class="modal-header">
	        <h5 class="modal-title">Details</h5>
	        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
	      </div>
	      <div class="modal-body" id="searchDetailContent">
	        <p class="text-muted mb-0">Bitte w√§hlen Sie einen Patienten oder Besitzer in der Suche.</p>
	      </div>
	    </div>
	  </div>
	</div>

	<!-- JS -->
	<script src="assets/js/bootstrap.bundle.min.js"></script>
	<script src="assets/js/jquery.min.js"></script>
	<script src="assets/plugins/simplebar/js/simplebar.min.js"></script>
	<script src="assets/plugins/metismenu/js/metisMenu.min.js"></script>
	<script src="assets/plugins/perfect-scrollbar/js/perfect-scrollbar.js"></script>
	<script src="assets/plugins/apexcharts-bundle/js/apexcharts.min.js"></script>
	<script src="assets/plugins/datatable/js/jquery.dataTables.min.js"></script>
	<script src="assets/plugins/datatable/js/dataTables.bootstrap5.min.js"></script>
	<script src="assets/plugins/notifications/js/lobibox.min.js"></script>
	<script src="assets/plugins/notifications/js/notifications.min.js"></script>
	<script src="assets/js/app.js"></script>

	<script>
	// Sidebar Toggle
	document.addEventListener("DOMContentLoaded", function() {
		const burger   = document.querySelector(".mobile-toggle-menu");
		const wrapper  = document.querySelector(".wrapper");
		const sidebar  = document.querySelector(".sidebar-wrapper");
		const overlay  = document.querySelector(".sidebar-overlay");
		const collapse = document.querySelector(".toggle-icon");

		burger.addEventListener("click", () => {
			const isDesktop = window.matchMedia("(min-width: 992px)").matches;
			if (isDesktop) {
				wrapper.classList.toggle("toggled");
			} else {
				sidebar.classList.toggle("active");
				overlay.classList.toggle("active");
			}
		});

		overlay.addEventListener("click", () => {
			sidebar.classList.remove("active");
			overlay.classList.remove("active");
		});

		if (collapse) {
			collapse.addEventListener("click", () => {
				wrapper.classList.toggle("toggled");
			});
		}

		window.addEventListener("resize", () => {
			const isDesktop = window.matchMedia("(min-width: 992px)").matches;
			if (isDesktop) {
				sidebar.classList.remove("active");
				overlay.classList.remove("active");
			}
		});
	});
	</script>

	<!-- Globale Suche: AJAX + Dropdown + Modal -->
	<script>
	(function() {
		const input   = document.getElementById('globalSearch');
		const box     = document.getElementById('searchResults');
		const modalEl = document.getElementById('searchDetailModal');

		let items      = [];
		let activeIdx  = -1;
		let lastQuery  = '';

		function debounce(fn, ms) {
			let t;
			return function(...args) {
				clearTimeout(t);
				t = setTimeout(() => fn.apply(this, args), ms);
			};
		}

		function hideResults() {
			box.style.display = 'none';
			box.innerHTML = '';
			activeIdx = -1;
			items = [];
		}

		function renderResults(results) {
			if (!results || results.length === 0) {
				box.innerHTML = '<div class="no-results">Keine Treffer</div>';
				box.style.display = 'block';
				items = [];
				activeIdx = -1;
				return;
			}
			let html = '';
			results.forEach((r, i) => {
				const badge = r.type === 'patient' ? 'Patient' : 'Besitzer';
				html += `
					<div class="result-item" data-index="${i}" data-type="${r.type}" data-id="${r.id}">
						<span class="badge">${badge}</span>
						<span>${escapeHtml(r.label)}</span>
					</div>`;
			});
			box.innerHTML = html;
			box.style.display = 'block';
			items = Array.from(box.querySelectorAll('.result-item'));

			items.forEach(el => {
				el.addEventListener('mouseenter', () => setActive(parseInt(el.dataset.index)));
				el.addEventListener('click', () => selectActive(parseInt(el.dataset.index)));
			});
		}

		function setActive(idx) {
			if (!items.length) return;
			items.forEach(el => el.classList.remove('active'));
			if (idx >= 0 && idx < items.length) {
				items[idx].classList.add('active');
				activeIdx = idx;
			}
		}

		function move(delta) {
			if (!items.length) return;
			let next = activeIdx + delta;
			if (next < 0) next = items.length - 1;
			if (next >= items.length) next = 0;
			setActive(next);
		}

		function selectActive(idx = activeIdx) {
			if (!items.length || idx < 0 || idx >= items.length) return;
			const el   = items[idx];
			const type = el.dataset.type;
			const id   = el.dataset.id;
			openDetail(type, id);
			hideResults();
		}

		function openDetail(type, id) {
			fetch(`api/search_detail.php?type=${encodeURIComponent(type)}&id=${encodeURIComponent(id)}`, {
				headers: { 'X-Requested-With': 'fetch' }
			})
			.then(r => r.text())
			.then(html => {
				document.getElementById('searchDetailContent').innerHTML = html || '<p class="text-muted">Keine Daten.</p>';
				const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
				modal.show();
			})
			.catch(() => {
				document.getElementById('searchDetailContent').innerHTML = '<div class="alert alert-danger">Fehler beim Laden.</div>';
				const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
				modal.show();
			});
		}

		function doSearch(q) {
			if (q.length < 2) { hideResults(); return; }
			fetch(`api/search.php?q=${encodeURIComponent(q)}`, {
				headers: { 'Accept': 'application/json' }
			})
			.then(r => r.json())
			.then(renderResults)
			.catch(() => {
				box.innerHTML = '<div class="no-results">Fehler bei der Suche</div>';
				box.style.display = 'block';
			});
		}

		const onInput = debounce(function(e) {
			const q = (e.target.value || '').trim();
			if (q === lastQuery) return;
			lastQuery = q;
			doSearch(q);
		}, 220);

		function onKeyDown(e) {
			if (box.style.display !== 'block') return;
			switch (e.key) {
				case 'ArrowDown': e.preventDefault(); move(1); break;
				case 'ArrowUp':   e.preventDefault(); move(-1); break;
				case 'Enter':     e.preventDefault(); selectActive(); break;
				case 'Escape':    hideResults(); break;
			}
		}

		function onClickOutside(e) {
			const within = box.contains(e.target) || input.contains(e.target);
			if (!within) hideResults();
		}

		function escapeHtml(str) {
			return (str || '').replace(/[&<>"']/g, function(m) {
				return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
			});
		}

		input.addEventListener('input', onInput);
		input.addEventListener('keydown', onKeyDown);
		document.addEventListener('click', onClickOutside);
	})();
	</script>

	{% if notifications %}
	<script>
	document.addEventListener("DOMContentLoaded", function() {
		let typeMap = {
			success: { icon: 'bx bx-check-circle' },
			error:   { icon: 'bx bx-x-circle' },
			warning: { icon: 'bx bx-error' },
			info:    { icon: 'bx bx-info-circle' }
		};
		{% for n in notifications %}
		let cfg{{ loop.index }} = typeMap["{{ n.type }}"] || typeMap.info;
		Lobibox.notify("{{ n.type }}", {
			pauseDelayOnHover: true,
			rounded: true,
			delay: 4000,
			size: 'mini',
			position: "top right",
			icon: cfg{{ loop.index }}.icon,
			msg: "{{ n.msg|e('js') }}"
		});
		{% endfor %}
	});
	</script>
	{% endif %}

	<link href="assets/css/owners_glass.css" rel="stylesheet">
	{% include "new_owner_patient.twig" %}
</body>
</html>