{% extends "layout.twig" %}

{% block inner_content %}
<div class="container py-4">

    <h2>‚úèÔ∏è Rechnung bearbeiten</h2>

    {% if errors %}
        <div class="alert alert-danger">
            <ul>
                {% for e in errors %}
                    <li>{{ e }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    <form method="post" class="bg-dark p-3 rounded shadow">
        {{ csrf_field()|raw }}

        <div class="mb-3">
            <label class="form-label">Patient</label>
            <select name="patient_id" class="form-select" required>
                {% for p in patients %}
                    <option value="{{ p.id }}"
                        {% if invoice.patient_id == p.id %}selected{% endif %}>
                        {{ p.patient_name }} ({{ p.firstname }} {{ p.lastname }})
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">Status</label>
            <select name="status" class="form-select">
                <option value="open" {% if invoice.status == 'open' %}selected{% endif %}>Offen</option>
                <option value="paid" {% if invoice.status == 'paid' %}selected{% endif %}>Bezahlt</option>
            </select>
        </div>

        <h5>Rechnungspositionen</h5>
        <div id="items">
            {% for item in items %}
            <div class="row mb-2">
                <div class="col-md-8">
                    <input type="text" name="items[{{ loop.index0 }}][description]" class="form-control"
                           value="{{ item.description }}" placeholder="Beschreibung">
                </div>
                <div class="col-md-4">
                    <input type="number" step="0.01" name="items[{{ loop.index0 }}][amount]" class="form-control"
                           value="{{ item.amount }}" placeholder="Betrag">
                </div>
            </div>
            {% else %}
            <div class="row mb-2">
                <div class="col-md-8">
                    <input type="text" name="items[0][description]" class="form-control" placeholder="Beschreibung">
                </div>
                <div class="col-md-4">
                    <input type="number" step="0.01" name="items[0][amount]" class="form-control" placeholder="Betrag">
                </div>
            </div>
            {% endfor %}
        </div>
        <button type="button" class="btn btn-secondary btn-sm mb-3" onclick="addItem()">‚ûï Weitere Position</button>

        <button type="submit" class="btn btn-success">üíæ √Ñnderungen speichern</button>
        <a href="invoices.php" class="btn btn-outline-light">‚Ü©Ô∏è Zur√ºck</a>
    </form>

</div>

<script>
let itemIndex = {{ items|length }};
function addItem() {
    const items = document.getElementById('items');
    const row = document.createElement('div');
    row.className = 'row mb-2';
    row.innerHTML = `
        <div class="col-md-8">
            <input type="text" name="items[${itemIndex}][description]" class="form-control" placeholder="Beschreibung">
        </div>
        <div class="col-md-4">
            <input type="number" step="0.01" name="items[${itemIndex}][amount]" class="form-control" placeholder="Betrag">
        </div>
    `;
    items.appendChild(row);
    itemIndex++;
}
</script>
{% endblock %}