{% extends "layout.twig" %}

{% block inner_content %}
<div class="row">
  <div class="col-12">

    <!-- Header -->
    <div class="card radius-10 mb-4">
      <div class="card-body d-flex justify-content-between align-items-center">
        <h4 class="mb-0"><i class="bx bx-calendar"></i> Terminverwaltung</h4>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newAppointmentModal">
          ➕ Neuer Termin
        </button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="card radius-10">
      <div class="card-header pb-0">
        <ul class="nav nav-tabs card-header-tabs" id="appointmentTabs" role="tablist">
          <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#list">🗂️ Terminliste</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#calendarTab">📆 Kalender</a></li>
        </ul>
      </div>

      <div class="card-body tab-content">

        <!-- Terminliste -->
        <div class="tab-pane fade show active" id="list">
          <div class="table-responsive">
            <table class="table table-striped table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>Datum</th>
                  <th>Patient</th>
                  <th>Besitzer</th>
                  <th>Notizen</th>
                </tr>
              </thead>
              <tbody>
                {% for a in appointments %}
                <tr>
                  <td><span class="badge bg-primary">{{ a.appointment_date|date("d.m.Y H:i") }}</span></td>
                  <td><strong>{{ a.patient_name }}</strong></td>
                  <td>{{ a.firstname }} {{ a.lastname }}</td>
                  <td>{{ a.notes|default("Keine Notizen") }}</td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="4" class="text-center text-muted">Keine Termine vorhanden</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Kalender -->
        <div class="tab-pane fade" id="calendarTab">
          <div id="calendar" style="min-height: 700px;"></div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Modal: Neuer Termin -->
<div class="modal fade" id="newAppointmentModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <form id="newAppointmentForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bx bx-plus"></i> Neuer Termin</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="date" id="appointmentDate">

        <div class="mb-3">
          <label class="form-label">Patient *</label>
          <select name="patient_id" id="appointmentPatient" class="form-select" required>
            <option value="">-- Patient auswählen --</option>
            {% for p in patients %}
              <option value="{{ p.id }}">{{ p.name }} ({{ p.firstname }} {{ p.lastname }})</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Notizen</label>
          <textarea name="notes" id="appointmentNotes" class="form-control"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">💾 Speichern</button>
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Abbrechen</button>
      </div>
    </form>
  </div>
</div>

<!-- FullCalendar -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  let calendarEl = document.getElementById('calendar');
  if (calendarEl) {
    let calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      locale: 'de',
      editable: true,
      selectable: true,
      height: 700,
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      events: 'api/appointments.php',
      dateClick: function(info) {
        document.getElementById('appointmentDate').value = info.dateStr;
        new bootstrap.Modal(document.getElementById('newAppointmentModal')).show();
      },
      eventDrop: function(info) {
        fetch('update_appointment.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: info.event.id, newDate: info.event.start.toISOString() })
        }).then(() => calendar.refetchEvents());
      },
      eventClick: function(info) {
        if (confirm('Diesen Termin löschen?')) {
          fetch('delete_appointment.php?id=' + info.event.id, { method: 'GET' })
          .then(() => calendar.refetchEvents());
        }
      }
    });
    calendar.render();
    document.getElementById('newAppointmentForm').addEventListener('submit', function(e) {
      e.preventDefault();
      let formData = {
        action: 'create',
        date: document.getElementById('appointmentDate').value,
        patient_id: document.getElementById('appointmentPatient').value,
        notes: document.getElementById('appointmentNotes').value
      };
      fetch('api/appointments.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      }).then(() => {
        bootstrap.Modal.getInstance(document.getElementById('newAppointmentModal')).hide();
        calendar.refetchEvents();
      });
    });
  }
});
</script>
{% endblock %}